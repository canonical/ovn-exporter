#!/bin/bash
# Wrapper script to ensure proper PATH and environment for ovnexporter
export PATH="$SNAP/bin:$SNAP_COMMON/ovn-commands/bin:$PATH"
export LD_LIBRARY_PATH="$SNAP_COMMON/ovn-commands/lib:$SNAP_COMMON/ovn-commands/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"

# Build CLI flags from snap configuration
CLI_ARGS=()

if OVN_RUNDIR=$(snapctl get ovn-rundir 2>/dev/null) && [ -n "$OVN_RUNDIR" ]; then
	CLI_ARGS+=("--ovn-rundir" "$OVN_RUNDIR")
fi

if OVS_RUNDIR=$(snapctl get ovs-rundir 2>/dev/null) && [ -n "$OVS_RUNDIR" ]; then
	CLI_ARGS+=("--ovs-rundir" "$OVS_RUNDIR")
fi

if OVS_VSWITCHD_PID=$(snapctl get ovs-vswitchd-pid 2>/dev/null) && [ -n "$OVS_VSWITCHD_PID" ]; then
	CLI_ARGS+=("--ovs-vswitchd-pid" "$OVS_VSWITCHD_PID")
fi

if OVSDB_SERVER_PID=$(snapctl get ovsdb-server-pid 2>/dev/null) && [ -n "$OVSDB_SERVER_PID" ]; then
	CLI_ARGS+=("--ovsdb-server-pid" "$OVSDB_SERVER_PID")
fi

if OVN_NBDB_LOCATION=$(snapctl get ovn-nbdb-location 2>/dev/null) && [ -n "$OVN_NBDB_LOCATION" ]; then
	CLI_ARGS+=("--ovn-nbdb-location" "$OVN_NBDB_LOCATION")
fi

if OVN_SBDB_LOCATION=$(snapctl get ovn-sbdb-location 2>/dev/null) && [ -n "$OVN_SBDB_LOCATION" ]; then
	CLI_ARGS+=("--ovn-sbdb-location" "$OVN_SBDB_LOCATION")
fi

exec "$SNAP/bin/ovnexporter" "${CLI_ARGS[@]}" "$@"
